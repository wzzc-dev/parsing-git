

é¢˜ç›®çš„ç›®æ ‡æ˜¯ç¼–å†™å¼•æ“ï¼Œèƒ½å¤Ÿè§£æ Git çš„å„ç§å¯¹è±¡ï¼Œå¹¶ä¸”èƒ½å¤Ÿä¸ºå¯¹è±¡è®¾è®¡æ•°æ®å­˜å‚¨æœºåˆ¶ï¼Œå¯ä»¥å°†å¯¹è±¡å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚

ç¬¬ä¸€ç« æˆ‘ä»¬é¦–å…ˆåˆ†æäº† git çš„å­˜å‚¨åŸç†ï¼›ç„¶ååœ¨ äºŒã€ä¸‰ç« èŠ‚åˆ†æäº† git object å’Œ packfile çš„å­˜å‚¨æœºåˆ¶å’Œè§£ææ–¹æ³•ï¼›ç¬¬å››ç« åˆ†æäº† git push è¿‡ç¨‹çš„ä¼ è¾“åè®®ï¼Œä½¿ç”¨ç½‘å…³ç¨‹åºæ‹¦æˆªä¿¡æ¯ï¼ˆpackfileæ–‡ä»¶ï¼‰å¹¶å°†å…¶å­˜å…¥æ•°æ®åº“é‡Œï¼›ç¬¬äº”ç« æ˜¯æ•°æ®åº“çš„ç°é˜¶æ®µè®¾è®¡ã€‚

# ä¸€ã€Gitå­˜å‚¨åŸç†åˆ†æ

## git å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå’Œ git å¯¹è±¡é—´çš„å…³ç³»

åˆ†æ git å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œå¯¹åº”å…³ç³»ã€‚å¯¹äº git å¯¹è±¡ ç°åœ¨é˜¶æ®µ éœ€è¦åˆ†æ commitã€ treeã€ blob ä¸‰ç§ç±»å‹çš„æ–‡ä»¶ï¼Œå‡ ç§å¯¹è±¡çš„çŠ¶æ€ï¼Œå­˜å‚¨æ–¹å¼è¦å®ç°å¯¹æäº¤å†…å®¹å®ç°æ•°æ®åº“æ”¯æŒçš„æ£€ç´¢ã€‚

git ç”Ÿå‘½å‘¨æœŸï¼šgit initï¼Œåˆå§‹åŒ–gité¡¹ç›®ï¼Œç”Ÿæˆ .git æ–‡ä»¶å¤¹åˆ›å»ºæ–‡ä»¶å¹¶git addä¹‹åï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ–‡ä»¶å¯¹åº”çš„ blob å¯¹è±¡ å­˜å‚¨åˆ° æ¾æ•£åŒº .git/object æ–‡ä»¶å¤¹git commit ä¹‹åï¼Œä¼šç”Ÿæˆtreeå¯¹è±¡å’Œ commitå¯¹è±¡å­˜å‚¨åˆ°  .git/object 

git å¯¹è±¡çš„å¯¹åº”å…³ç³»ï¼šä¸€ä¸ª commit å¯¹åº”ä¸€ä¸ª treeä¸€ä¸ª tree å¯¹åº” 1ä¸ª blob+1ä¸ªtree ï¼ˆn>=0ï¼‰ä¸€ä¸ª tag å¯¹åº” ä¸€ä¸ª commit
![è¾“å…¥å›¾ç‰‡è¯´æ˜](https://images.gitee.com/uploads/images/2021/0808/164251_3ac2fdd7_2109625.png "å±å¹•æˆªå›¾.png")

## å‚¨å­˜å¯¹è±¡æ–¹å¼

Git ä¿å­˜å¯¹è±¡çš„æ ¼å¼æœ‰ä¸¤ç§â€”â€”æ¾æ•£å¯¹è±¡å’Œæ‰“åŒ…å¯¹è±¡ã€‚

### gitå¯¹è±¡å‚¨å­˜ç›®å½•è®¾è®¡é€»è¾‘

.git/objects ç›®å½•çš„è®¾è®¡é€»è¾‘(åœ¨ objects ç›®å½•ä¸‹ç”Ÿæˆæ–‡ä»¶å¤¹å’Œæ–‡ä»¶)

æ•°æ®blobå¯¹è±¡ã€æ ‘treeå¯¹è±¡å’Œæäº¤commitå¯¹è±¡éƒ½æ˜¯åœ¨.git/objectsç›®å½•ä¸‹ä»¥key-valueå½¢å¼å­˜å‚¨ï¼Œkeyæ˜¯Gitå¯¹è±¡çš„40ä½hashï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿé‡Œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå¤´ä¸¤ä½ä½œä¸ºæ–‡ä»¶å¤¹ï¼Œå38ä½ä½œä¸ºå¯¹è±¡æ–‡ä»¶åï¼ˆç›®çš„æ˜¯å‡å°‘æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶æ•°ç›®ï¼ŒæŸ¥æ‰¾æ›´å¿«ï¼‰ã€‚

hashçš„è®¡ç®—ï¼š

> header = "<type>" + " (ç©ºæ ¼)" + content.length(æ•°æ®å†…å®¹çš„å­—èŠ‚æ•°) + "\0"
>
> hash = sha1(header + content)

tree/blob/commit object å¯¹è±¡çš„å­˜å‚¨æœºåˆ¶:

Gitå¯¹è±¡ä¼šåœ¨åŸå†…å®¹å‰åŠ ä¸ªä¸€ä¸ªå¤´éƒ¨ï¼š

> store = header + content

å¤´éƒ¨

> header = "<type>" + content.length + "\0"

> hash = sha1(header + content)

Gitå¯¹è±¡åœ¨å­˜å‚¨å‰ï¼Œä¼šä½¿ç”¨zlibçš„deflateç®—æ³•è¿›è¡Œå‹ç¼©ï¼Œå³ç®€è¦æè¿°ä¸ºï¼š

> zlib_store = zlib.deflate(store)

contentå†…å®¹ä¿å­˜æ–¹å¼

> æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ã€‚ã€‚ã€‚ã€‚ã€‚
>
> store = header + content äºŒè¿›åˆ¶æ‹¼æ¥



# äºŒã€è§£æGit Object.md

### object å¯¹è±¡çš„å­˜å‚¨æœºåˆ¶

#### æ•°æ®å¯¹è±¡ blob

blob <content length><NULL><content>

- å‚¨å­˜æ–‡ä»¶å†…å®¹ï¼Œä¸åŒ…æ‹¬æ–‡ä»¶åï¼Œç»è¿‡SHA1å“ˆå¸Œç®—æ³•å¾—åˆ°å¯¹åº”çš„å“ˆå¸Œå€¼

#### æ ‘å¯¹è±¡ tree

tree <content length><NULL><file mode> <filename><NULL><item sha>...

- <item sha>éƒ¨åˆ†æ˜¯äºŒè¿›åˆ¶å½¢å¼çš„sha1ç ï¼Œè€Œä¸æ˜¯åå…­è¿›åˆ¶å½¢å¼çš„sha1ç ã€‚
- æ ‘å¯¹è±¡ï¼Œä½œç”¨æ˜¯å­˜å‚¨ç›®å½•ä¿¡æ¯ï¼ŒåŒ…å«äº†næ¡æ ‘å¯¹è±¡è®°å½•å’Œnä¸ªæ•°æ®å¯¹è±¡è®°å½•ï¼Œ
- å…¶ä¸­æ¯æ¡è®°å½•éƒ½æŒ‡å‘ä¸€ä¸ªæ•°æ®å¯¹è±¡æˆ–è€…æ˜¯å­æ ‘å¯¹è±¡çš„SHA-1æŒ‡é’ˆä»¥åŠç›¸åº”çš„æ¨¡å¼ã€ç±»å‹ã€æ–‡ä»¶å

#### æäº¤å¯¹è±¡ commit

>commit <content length><NUL>tree <tree sha>
>
>parent <parent sha>[parent <parent sha> if several parents from merges]
>
>author <author name> <author e-mail> <timestamp> <timezone>
>
>
>
>committer <author name> <author e-mail> <timestamp> <timezone>â€‹
>
><commit message>

- æäº¤å¯¹è±¡ä¸­åŒ…å«ä¸€ä¸ªæ ‘å¯¹è±¡æ¡ç›®ï¼Œä»£è¡¨ç€å½“å‰é¡¹ç›®å¿«ç…§
- å…¶ä»–ä¹‹å¤–è¿˜æœ‰ä¸€äº›ä½œè€…/æäº¤è€…çš„ä¿¡æ¯ï¼Œ
- æœ€åä¸€è¡Œæ˜¯æäº¤æ³¨é‡Šã€‚

ä¸€ä¸ª commit å¯èƒ½ä¼šæœ‰å¤šä¸ª parent

![è¾“å…¥å›¾ç‰‡è¯´æ˜](https://images.gitee.com/uploads/images/2021/0808/164331_ba8f0587_2109625.png "å±å¹•æˆªå›¾.png")

#### Tag

- **Tag å¯¹è±¡:**æ‰“ä¸Š tag ä¹‹åï¼Œè¿™ä¸ª tag ä»£è¡¨çš„å†…å®¹å°†æ°¸è¿œä¸å¯å˜ï¼Œå› ä¸º tag åªä¼šå…³è”å½“æ—¶ç‰ˆæœ¬åº“ä¸­æœ€åä¸€ä¸ª commit å¯¹è±¡ã€‚
- Tag ç±»å‹æœ‰ä¸¤ç§ï¼š
- **1 lightweight (è½»é‡çº§)**   git tag tagName
- è¿™ç§æ–¹å¼åˆ›å»ºçš„ Tagï¼Œgit åº•å±‚ä¸ä¼šåˆ›å»ºä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„ tag å¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥æŒ‡å‘ä¸€ä¸ª commit å¯¹è±¡ï¼Œæ­¤æ—¶å¦‚æœä½¿ç”¨ git cat-file -t tagName ä¼šè¿”å›ä¸€ä¸ª commitã€‚
- **2 annotated (å«é™„æ³¨)**    git tag -a tagName -m''
- è¿™ç§æ–¹å¼åˆ›å»ºçš„æ ‡ç­¾ï¼Œgit åº•å±‚ä¼šåˆ›å»ºä¸€ä¸ª tag å¯¹è±¡ï¼Œtag å¯¹è±¡ä¼šåŒ…å«ç›¸å…³çš„ commit ä¿¡æ¯å’Œ tagger ç­‰é¢å¤–ä¿¡æ¯ï¼Œæ­¤æ—¶å¦‚æœä½¿ç”¨ git cat-file -t tagname ä¼šè¿”å›ä¸€ä¸ª tag

##### tag å†…å®¹

> object d5d55a49c337d36e16dd4b05bfca3816d8bf6de8   //commit å¯¹è±¡SHA-1 
>
> type commit
>
> tag v3    //tagName 
>
> tagger xxx  1506230900 +0800 //æœ¬æ¬¡commitçš„äºº 
>
> 
>
> message

#### branch

æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæœ‰åå­—çš„æŒ‡é’ˆï¼ŒæŒ‡å‘ç‰¹å®šçš„commit

- æŒ‡å‘è‡ªå·±çš„æœ€æ–°çš„commit

![è¾“å…¥å›¾ç‰‡è¯´æ˜](https://images.gitee.com/uploads/images/2021/0808/164402_da1fbb9d_2109625.png "å±å¹•æˆªå›¾.png")

HEADæ–‡ä»¶æŒ‡é’ˆï¼šæŒ‡å‘å½“å‰å·¥ä½œåˆ†æ”¯çš„æœ€æ–°commit

![è¾“å…¥å›¾ç‰‡è¯´æ˜](https://images.gitee.com/uploads/images/2021/0808/164417_e6e4c21b_2109625.png "å±å¹•æˆªå›¾.png")


- åˆ†æ”¯ä¿å­˜åœ¨ .git/refs/heads/ï¼ˆåˆ†æ”¯åï¼šæŒ‡å‘->commitï¼‰ 

![è¾“å…¥å›¾ç‰‡è¯´æ˜](https://images.gitee.com/uploads/images/2021/0808/164445_f39850d5_2109625.png "å±å¹•æˆªå›¾.png")

#### remote

- æ‰§è¡Œgit remote add origin [http://xxxxxxx](http://xxxxxxx/)
- ç”Ÿæˆ .git/config

> [remote "origin"]
>
> â€‹	url = è¿œç¨‹ä»“åº“åœ°å€
>
> â€‹	fetch = å¯¹åº”è¿œç¨‹ä»“åº“æœ¬åœ°ä»“åº“åˆ†æ”¯ä¿¡æ¯git

- æœ¬åœ°ç”Ÿæˆè¿œç¨‹è¿œç¨‹ä»“åº“ä¿¡æ¯
  - .git/refs/remotes/ï¼ˆsha-1->åˆ†æ”¯æŒ‡å‘commitï¼‰

![è¾“å…¥å›¾ç‰‡è¯´æ˜](https://images.gitee.com/uploads/images/2021/0808/164901_2966d781_2109625.png "å±å¹•æˆªå›¾.png")





# ä¸‰ã€è§£æGit Packfile.md

## gitå¯¹è±¡çš„å‹ç¼©

- å‹ç¼©ä¸»è¦æ˜¯ blobï¼Œadd ä¹‹åå°±ä¼šå‹ç¼©ï¼ˆå‹ç¼©ç‡ä¸åŒï¼Œé‡å¤ç‡é«˜çš„txtå‹ç¼©ç‡é«˜ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶åè€Œæ¯”åŸå§‹æ–‡ä»¶å¤§ä¸€äº›ï¼‰ï¼Œä½¿ç”¨ zlib è¿›è¡Œå‹ç¼©ã€‚
- git gcåï¼Œå†æ¬¡å‹ç¼©ï¼ˆç›¸ä¼¼æ–‡ä»¶å­˜å‚¨ç¬¬ä¸€ä¸ªå¯¹è±¡å’Œç¬¬äºŒä¸ªå¯¹è±¡å­˜å‚¨çš„å·®å¼‚ï¼‰---> å‡ºç°ä¸¤ä¸ªæ–‡ä»¶ idxã€packï¼›

packfile ä¿¡æ¯æ ¼å¼ 

> SHA-1 type size size-in-packfile offset-in-packfile depth base-SHA-1

![è¾“å…¥å›¾ç‰‡è¯´æ˜](https://images.gitee.com/uploads/images/2021/0808/164556_0c04a7f2_2109625.png "å±å¹•æˆªå›¾.png")

git gc ä¹‹å æ‰“åŒ…æˆä¸€ä¸ªpackfileï¼Œoffset-in-packfile è®°å½•åœ¨packfileå†…çš„åç§»é‡

## pack ç›®å½•ä¸‹çš„é€»è¾‘(idxã€pack)

- ä¸Šé¢éƒ½æ˜¯æ¾æ•£åŒºï¼Œå½“å¢åŠ å¤§é‡å†…å®¹å¤§å°å‡ ä¹å®Œå…¨ç›¸åŒçš„å¯¹è±¡ï¼Œ æ‰‹åŠ¨æ‰§è¡Œ git gc å‘½ä»¤ï¼Œæˆ–è€…å‘è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œæ¨é€æ—¶ï¼Œè¿™äº›å¯¹è±¡æ‰“åŒ…æˆä¸€ä¸ªç§°ä¸ºâ€œåŒ…æ–‡ä»¶ï¼ˆpackfileï¼‰â€çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
- åŸç†ï¼šGit ä¼šå®Œæ•´ä¿å­˜å…¶ä¸­ä¸€ä¸ªï¼Œå†ä¿å­˜å¦ä¸€ä¸ªå¯¹è±¡ä¸ä¹‹å‰ç‰ˆæœ¬çš„å·®å¼‚å†…å®¹ã€‚å³Gitå°†åªä¿å­˜ç¬¬äºŒä¸ªæ–‡ä»¶ä¸­æ›´æ”¹çš„éƒ¨åˆ†ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸ä¹‹ç›¸ä¼¼çš„æ–‡ä»¶ã€‚å¹¶ä½¿ç”¨ä¸€ä¸ªæŒ‡å‘è¯¥æ–‡ä»¶çš„æŒ‡é’ˆã€‚
- å…·ä½“è¿‡ç¨‹ï¼šä¼šæ–°åˆ›å»ºä¸€ä¸ªåŒ…æ–‡ä»¶packå’Œä¸€ä¸ªç´¢å¼•idxï¼ŒåŒ…æ–‡ä»¶åŒ…å«äº†æ‰“åŒ…æ—¶ä»æ–‡ä»¶ç³»ç»Ÿä¸­ç§»é™¤çš„æ‰€æœ‰å¯¹è±¡çš„å†…å®¹ã€‚ ç´¢å¼•æ–‡ä»¶åŒ…å«äº†åŒ…æ–‡ä»¶çš„åç§»ä¿¡æ¯ï¼Œé€šè¿‡ç´¢å¼•æ–‡ä»¶å°±å¯ä»¥å¿«é€Ÿå®šä½ä»»æ„ä¸€ä¸ªæŒ‡å®šå¯¹è±¡ã€‚
-  git verify-pack å‘½ä»¤æŸ¥çœ‹å·²æ‰“åŒ…çš„å†…å®¹
- 1,2,3 commit - pack1 idx1; 4,5 commit - pack2 idx2;

## unpack

- æ–°å»ºä¸€ä¸ª git é¡¹ç›® git init newrepo         cd newrepo
- git unpack-objects < åŸé¡¹ç›®/.git/objects/xxxx.pack

## packæ–¹å¼

- æ¾æ•£æ–‡ä»¶æ‰“åŒ…æˆpackã€idxè¿‡ç¨‹
- ä¸¤æ¬¡packé—´çš„è¿‡ç¨‹
  - åä¸€ä¸ªæ›¿æ¢å‰ä¸€ä¸ª
- ç´¢å¼•çš„æ–¹å¼
  - ç›¸ä¼¼æ–‡ä»¶ä»¥æœ€åä¸€æ¬¡commitçš„æ–‡ä»¶ä¸ºæºæ–‡ä»¶ï¼Œä¹‹å‰çš„ä¿å­˜ä¸å…¶çš„å·®å¼‚ã€‚

## packfile è§£æ

å› ä¸ºåªä¼ è¾“packfileæ–‡ä»¶ï¼Œ æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦ä» packfile ä¸­è§£æå‡º packfile çš„ç´¢å¼•ï¼Œ

Packfile ä»¥12å­—èŠ‚çš„å…ƒä¿¡æ¯å¼€å§‹ï¼Œä»¥20å­—èŠ‚çš„æ ¡éªŒå’Œç»“æŸï¼Œæ‰€æœ‰è¿™äº›éƒ½å¯ä»¥ç”¨æ¥éªŒè¯æˆ‘ä»¬çš„ç»“æœã€‚å‰å››ä¸ªå­—èŠ‚æ‹¼å†™ä¸ºâ€œ PACKâ€ï¼Œåå››ä¸ªå­—èŠ‚åŒ…å«ç‰ˆæœ¬å·â€”â€”åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­æ˜¯[0,0,0,2]ã€‚æ¥ä¸‹æ¥çš„å››ä¸ªå­—èŠ‚æ˜¯åŒ…ä¸­åŒ…å«çš„å¯¹è±¡æ•°ï¼Œæ‰€ä»¥ä¸€ä¸ª packfile ä¸èƒ½åŒ…å«è¶…è¿‡2^32ä¸ªå¯¹è±¡ã€‚åé¢æ˜¯ä¸€ç³»åˆ—æ‰“åŒ…çš„å¯¹è±¡ï¼ŒæŒ‰ç…§å®ƒä»¬çš„ SHAs é¡ºåºæ’åˆ—ï¼Œæ¯ä¸ª SHAs ç”±ä¸€ä¸ªå¯¹è±¡å¤´å’Œå¯¹è±¡å†…å®¹ç»„æˆã€‚Packfile çš„æœ«å°¾æ˜¯è¯¥ packfile ä¸­æ‰€æœ‰ shas (æŒ‰æ’åºé¡ºåº)çš„20å­—èŠ‚ SHA1å’Œã€‚

Packfile çš„æ ¸å¿ƒæ˜¯ä¸€ç³»åˆ—æ‰“åŒ…çš„å¯¹è±¡ï¼Œæ¯ä¸ªæ•°æ®å—å‰é¢éƒ½æœ‰ä¸€äº›å…ƒä¿¡æ¯ã€‚å…ƒä¿¡æ¯åé¢çš„æ•°æ®æ˜¯ zlib å‹ç¼©çš„å¯¹è±¡æ•°æ®ï¼Œåœ¨ä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡è§£æå¯¹è±¡çš„æ–¹æ³•ã€‚å…ƒä¿¡æ¯æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ª1å­—èŠ‚(8ä½)å¤§å—ç»„æˆçš„åºåˆ—ï¼Œç”¨äºæŒ‡å®šä»¥ä¸‹æ•°æ®çš„å¯¹è±¡ç±»å‹ä»¥åŠå±•å¼€æ—¶çš„æ•°æ®å¤§å°ã€‚æ¯ä¸ªå­—èŠ‚å®é™…ä¸Šæ˜¯7ä½çš„æ•°æ®ï¼Œç¬¬ä¸€ä½ç”¨æ¥è¡¨ç¤ºæ•°æ®å¼€å§‹ä¹‹å‰æ˜¯å¦æ˜¯æœ€åä¸€ä½ã€‚å¦‚æœç¬¬ä¸€ä½æ˜¯1ï¼Œé‚£ä¹ˆå°†è¯»å–å¦ä¸€ä¸ªå­—èŠ‚ï¼Œå¦åˆ™æ•°æ®å°†ä»ä¸‹ä¸€ä½å¼€å§‹ã€‚æ ¹æ®ä¸‹è¡¨ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰3ä½æŒ‡å®šäº†æ•°æ®çš„ç±»å‹ã€‚

> obj_commit = 001
>
> obj_tree = 010
>
> obj_blob = 011
>
> obj_tag = 100
>
> obj_ofs_delta = 110
>
> obj_ref_delta = 111

ä¸¤ç§ç‰¹åˆ«çš„å‹ç¼©æ–¹å¼ï¼š

- ofs
  - è¡¨ç¤ºçš„æ˜¯ Delta å­˜å‚¨ï¼Œå½“å‰ git å¯¹è±¡åªæ˜¯å­˜å‚¨äº†å¢é‡éƒ¨åˆ†ï¼Œå¯¹äºåŸºæœ¬çš„éƒ¨åˆ†å°†ç”±æ¥ä¸‹æ¥çš„å¯å˜é•¿åº¦çš„å­—èŠ‚æ•°ç”¨äºè¡¨ç¤º base object çš„è·ç¦»å½“å‰å¯¹è±¡çš„åç§»é‡ï¼Œæ¥ä¸‹æ¥çš„å¯å˜å­—èŠ‚ä¹Ÿæ˜¯ç”¨ 1-bit MSB è¡¨ç¤ºä¸‹ä¸€ä¸ªå­—èŠ‚æ˜¯å¦æ˜¯å¯å˜é•¿åº¦çš„ç»„æˆéƒ¨åˆ†ã€‚å¯¹åç§»é‡å–è´Ÿæ•°ï¼Œå°±å¯çŸ¥ base å¯¹è±¡åœ¨å½“å‰å¯¹è±¡çš„å‰é¢å¤šå°‘å­—èŠ‚
- ref
  - è¡¨ç¤ºçš„æ˜¯ Delta å­˜å‚¨ï¼Œå½“å‰ git å¯¹è±¡åªæ˜¯å­˜å‚¨äº†å¢é‡éƒ¨åˆ†ï¼Œå¯¹äºåŸºæœ¬çš„éƒ¨åˆ†ï¼Œç”¨ 20-bytes å­˜å‚¨ Base Object çš„ SHA-1 ã€‚

# å››ã€ç½‘å…³

æœ¬é¡¹ç›®ä½¿ç”¨ tokio çš„ Webæ¡†æ¶ Axum ç¼–å†™ ç½‘å…³ç¨‹åºï¼Œ åœ¨è¿™ä¹‹å‰é¦–å…ˆè¦äº†è§£ git å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ä¼ è¾“åè®®ã€‚

## ä¼ è¾“åè®®

ä¸¤ç§ä¸»è¦çš„æ–¹å¼åœ¨ç‰ˆæœ¬åº“ä¹‹é—´ä¼ è¾“æ•°æ®ï¼šâ€œå“‘ï¼ˆdumbï¼‰â€åè®®å’Œâ€œæ™ºèƒ½ï¼ˆsmartï¼‰â€åè®®

### å“‘åè®®

å“‘åè®®ç‰¹ç‚¹å¦‚ä¸‹

- åªè¯»ï¼Œåªæä¾›ä¸‹è½½
- 1ã€æ‹‰å–info/refs  GET info/refs å¾—åˆ°ä¸€ä¸ªè¿œç¨‹å¼•ç”¨å’Œ SHA-1 å€¼çš„åˆ—ï¼›2ã€ç¡®å®š HEAD å¼•ç”¨ GET HEAD ref: refs/heads/masterï¼›3ã€å¾—åˆ°åˆ†æ”¯å¯¹è±¡ï¼ˆç¬¬äºŒéƒ¨masteræŒ‡å‘çš„ï¼‰ï¼Œä¸€ä¸ªcommitå¯¹è±¡ï¼ˆmasterï¼‰GET objects/xx/xxxxxï¼›4ã€è·å–ç¬¬ä¸‰æ­¥å¯¹åº”çš„treeå¯¹è±¡å’Œçˆ¶æäº¤ GET objects/xx/xxxxï¼›å¯èƒ½æ— æ³•æ‰¾åˆ° åˆ™éœ€è¦è·å– packfile  GET objects/info/packs

å“‘åè®®æ•ˆç‡ç•¥ä½ï¼Œè€Œä¸”å®ƒä¸èƒ½ä»å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€æ•°æ®ã€‚ æ‰€ä»¥æˆ‘ä»¬è¦ä½¿ç”¨çš„æ˜¯æ™ºèƒ½åè®®ã€‚

### æ™ºèƒ½åè®®

æ™ºèƒ½åè®®åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

#### 1ã€å¼•ç”¨å‘ç° 

- GET https://{ä»“åº“åœ°å€}/info/refs?service=git-{upload|receive}-pack
  - æœåŠ¡ç«¯çš„å„ä¸ªå¼•ç”¨çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œè®©æœåŠ¡ç«¯æˆ–è€…å®¢æˆ·ç«¯çŸ¥é“ä¸¤æ–¹ä¹‹é—´çš„å·®å¼‚ä»¥åŠéœ€è¦ä»€ä¹ˆæ ·çš„æ•°æ®ã€‚
  - å®¢æˆ·ç«¯è¯·æ±‚ 
    - => GET http://server/simplegit-progit.git/info/refs?service=git-receive-pack
  - æœåŠ¡ç«¯å›åº”
    - 001f# service=git-receive-pack 00ab6c5f0e45abd7832bf23074a333f739977c9e8188 refs/heads/master report-status \ delete-refs side-band-64k quiet ofs-delta \ agent=git/2:2.1.1~vmg-bitmaps-bugaloo-608-g116744e 0000
    - ç¬¬ä¸€é¦–è¡Œçš„å››ä¸ªå­—ç¬¦ç¬¦åˆæ­£åˆ™^[0-9a-f]{4}#ï¼Œè¿™é‡Œçš„å››ä¸ªå­—ç¬¦æ˜¯ä»£è¡¨åé¢å†…å®¹çš„é•¿åº¦ ç„¶åæ˜¯# service=$servicenameï¼›æ¯ä¸€è¡Œç»“å°¾éœ€è¦åŒ…å«ä¸€ä¸ªLFæ¢è¡Œç¬¦ï¼›ä»¥0000æ ‡è¯†ç»“æŸæœ¬æ¬¡è¯·æ±‚å“åº”
- master åˆ†æ”¯å’Œå®ƒçš„ SHA-1 å€¼ã€‚ ç¬¬ä¸€è¡Œå“åº”ä¸­ä¹ŸåŒ…å«äº†ä¸€ä¸ªæœåŠ¡ç«¯èƒ½åŠ›çš„åˆ—è¡¨ï¼ˆè¿™é‡Œæ˜¯ report-statusã€delete-refs å’Œä¸€äº›å…¶å®ƒçš„ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯çš„è¯†åˆ«ç ï¼‰ã€‚

#### 2ã€æ•°æ®ä¼ è¾“ 

- POST https://{ä»“åº“åœ°å€}/git-{upload|receive}-pack

- æ•°æ®ä¼ è¾“åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä¼ è¾“ï¼ˆPushï¼‰ã€æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯ä¼ è¾“ï¼ˆFetchï¼‰ã€‚

- Push æ“ä½œè·å–åˆ°æœåŠ¡ç«¯çš„å¼•ç”¨åˆ—è¡¨åï¼Œç”± å®¢æˆ·ç«¯ æœ¬åœ°è®¡ç®—å‡ºå®¢æˆ·ç«¯æ‰€ç¼ºå¤±çš„æ•°æ®ï¼Œå°†è¿™äº›æ•°æ®æ‰“åŒ…ï¼Œå¹¶POSTç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°åè¿›è¡Œè§£å‹å’Œå¼•ç”¨æ›´æ–°

  - Push æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šæ ¹æ®æœåŠ¡ç«¯çš„å¼•ç”¨ä¿¡æ¯è®¡ç®—å‡ºæœåŠ¡ç«¯æ‰€éœ€è¦çš„å¯¹è±¡ï¼Œç›´æ¥é€šè¿‡ Post è¯·æ±‚å‘é€ç»™æœåŠ¡ç«¯ï¼Œå¹¶åŒæ—¶é™„å¸¦ä¸€äº›æŒ‡ä»¤ä¿¡æ¯ï¼Œæ¯”å¦‚æ–°å¢ã€åˆ é™¤ã€æ›´æ–°å“ªäº›å¼•ç”¨ï¼Œä»¥åŠæ›´æ–°å‰åçš„ç‰ˆæœ¬ï¼Œ

- => POST http://server/simplegit-progit.git/git-receive-pack

  - è¯·æ±‚çš„å†…å®¹æ˜¯ send-pack çš„è¾“å‡ºå’Œç›¸åº”çš„åŒ…æ–‡ä»¶ã€‚

  - çŸ¥é“äº†æœåŠ¡ç«¯çš„çŠ¶æ€ï¼Œ send-pack è¿›ç¨‹ä¼šåˆ¤æ–­å“ªäº›æäº¤è®°å½•æ˜¯å®ƒæ‰€æ‹¥æœ‰ä½†æœåŠ¡ç«¯æ²¡æœ‰çš„ã€‚ send-pack ä¼šå‘ŠçŸ¥ receive-pack è¿™æ¬¡æ¨é€å°†ä¼šæ›´æ–°çš„å„ä¸ªå¼•ç”¨ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æ­£åœ¨æ›´æ–° master åˆ†æ”¯ï¼Œå¹¶ä¸”å¢åŠ  experiment åˆ†æ”¯ï¼Œè¿™ä¸ª send-pack çš„å“åº”å°†ä¼šæ˜¯åƒè¿™æ ·ï¼š
    - 0076ca82a6dff817ec66f44342007202690a93763949 15027957951b64cf874c3557a0f3547bd83b3ff6 \ refs/heads/master report-status 006c0000000000000000000000000000000000000000 cdfdb42577e2506715f8cfeacdbabc092bf63e8d \ refs/heads/experiment 0000
  - ç¬¬ä¸€è¡Œä¹ŸåŒ…æ‹¬äº†å®¢æˆ·ç«¯çš„èƒ½åŠ›ã€‚ è¿™é‡Œçš„å…¨ä¸º **0** çš„ SHA-1 å€¼è¡¨ç¤ºä¹‹å‰æ²¡æœ‰è¿‡è¿™ä¸ªå¼•ç”¨â€”â€”å› ä¸ºä½ æ­£è¦æ·»åŠ æ–°çš„ experiment å¼•ç”¨ã€‚ åˆ é™¤å¼•ç”¨æ—¶ï¼Œå°†ä¼šçœ‹åˆ°ç›¸åçš„æƒ…å†µï¼šå³è¾¹çš„ SHA-1 å€¼å…¨ä¸º **0**ã€‚
  - ç„¶åï¼Œå®¢æˆ·ç«¯ä¼šå‘é€ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰æœåŠ¡ç«¯ä¸Šæ‰€æ²¡æœ‰çš„å¯¹è±¡çš„åŒ…æ–‡ä»¶ã€‚ 
    - è¿™é‡Œçš„åŒ…æ•°æ®æ ¼å¼ä¸º"PACK" <binary data>ï¼Œä¼šä»¥PACKå¼€å¤´ã€‚æœåŠ¡ç«¯æ¥æ”¶åˆ°è¿™äº›æ•°æ®åï¼Œå¯åŠ¨ä¸€ä¸ªè¿œç¨‹è°ƒç”¨å‘½ä»¤receive-packï¼Œç„¶åå°†æ•°æ®ä»¥ç®¡é“çš„å½¢å¼ä¼ ç»™è¿™ä¸ªå‘½ä»¤å³å¯ã€‚pack<binary date>
  - æœ€ç»ˆï¼ŒæœåŠ¡ç«¯ä¼šå“åº”ä¸€ä¸ªæˆåŠŸï¼ˆæˆ–å¤±è´¥ï¼‰çš„æ ‡è¯†ã€‚
    - 000eunpack ok


## tokio-rs/axum

axum æ˜¯ä¸€ä¸ªä½¿ç”¨äº† Tokioã€Tower å’Œ Hyperï¼Œå¹¶ä¸“æ³¨äºæ¨¡å—åŒ–çš„ Web åº”ç”¨ç¨‹åºæ¡†æ¶ã€‚

æ ¹æ®åè®®ç½‘å…³æä¾›äº†ä¸¤ä¸ªè¯·æ±‚ å¼•ç”¨å‘ç°çš„ info/refsï¼Œæ•°æ®ä¼ è¾“ç”¨åˆ°çš„ git-receive-pack

å¼•ç”¨å‘ç°è¿”å›æœ¬åœ°ä»“åº“å·®å¼‚ç»“æœï¼Œç„¶åå®¢æˆ·ç«¯ä¼šä¼ ç»™æœåŠ¡å™¨ä¸€ä¸ªåŒ…å«packfileçš„è¯·æ±‚ï¼Œæˆ‘ä»¬ä»è¿™ä¸ªè¯·æ±‚ä¸­å¾—åˆ° packfile ç„¶åè§£æä»–å°±å¯ä»¥å¾—åˆ° packfile å†…æ‰€æœ‰ git å¯¹è±¡çš„ç´¢å¼•ä¿¡æ¯å’Œå†…å®¹ã€‚è§£æè¿‡ç¨‹è§ç¬¬ä¸‰ç«  packfile è§£æã€‚

ä¸»è¦è¿‡ç¨‹æ˜¯:

- 1ã€è¯» pacfile å»ºç«‹ indexï¼ˆå…ˆæŠŠç´¢å¼•è§£æå‡ºæ¥ï¼‰

- 2ã€æ ¹æ®ç´¢å¼•å†è¯» packfile ï¼ˆç´¢å¼•è¦å€’åºï¼Œå»ºç«‹ vec indexï¼‰
- 3ã€è¯» index çš„æ—¶å€™å†™æ•°æ®åº“ï¼Œ

# äº”ã€æ•°æ®åº“è®¾è®¡

æ•°æ®åº“ä½¿ç”¨äº† mysql ï¼Œä½¿ç”¨çš„æ˜¯ å¼‚æ­¥çš„ Rust SQL Toolkit ï¼šsqlx æ¥å†™å…¥æ•°æ®çš„ã€‚

```sql
create datebase git;
create table git_index
(
	sha_1 char(40) null,
	obj_type TINYINT UNSIGNED null,
	size BIGINT UNSIGNED null,
	size_in_packfile BIGINT UNSIGNED null,
	offset_in_pack BIGINT UNSIGNED null,
	depth BIGINT UNSIGNED null,
	base_sha_1 char(40) null
)
comment 'git å¯¹è±¡ç´¢å¼•';

create table `blob`
(
	sha_1 char(40) null,
	name varchar(256) null,
	context text null,
	file_type varchar(64) null
);

```

æ–‡ä»¶å†…å®¹éƒ¨åˆ†æš‚æ—¶ä»¥ blob å­˜å‚¨æ‰€æœ‰ç±»å‹ï¼Œä¹‹åè®¡åˆ’æå–ä¿¡æ¯æ„å»º commitã€treeç­‰å¯¹è±¡ç±»å‹

# å‚è€ƒèµ„æ–™

[Git - Book](https://git-scm.com/book/zh/v2)

[Unpacking Git packfiles (recurse.com)](https://codewords.recurse.com/issues/three/unpacking-git-packfiles)

[Git Book - The Packfile (shafiul.github.io)](http://shafiul.github.io/gitbook/7_the_packfile.html)

[Git - ä¼ è¾“åè®® (git-scm.com)](https://git-scm.com/book/zh/v2/Git-å†…éƒ¨åŸç†-ä¼ è¾“åè®®)

[launchbadge/sqlx: ğŸ§° The Rust SQL Toolkit](https://github.com/launchbadge/sqlx)

[tokio-rs/axum](https://github.com/tokio-rs/axum)

